#!/bin/bash

echo "üîß –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
echo "============================================="

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose-fixed.yml down

# –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–º–∞
echo "üßπ –û—á–∏—â–∞–µ–º —Ç–æ–º–∞..."
docker volume rm gtmall_traefik_acme gtmall_traefik_logs 2>/dev/null || true

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üìù –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cp traefik/traefik-final.yml traefik/traefik.yml

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cat traefik/traefik.yml | grep -A 5 -B 5 "certificates"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
docker-compose -f docker-compose-fixed.yml up -d

# –ñ–¥–∞—Ç—å –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
docker-compose -f docker-compose-fixed.yml ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
echo "üìã –õ–æ–≥–∏ Traefik:"
docker logs gtm_traefik --tail=10

# –¢–µ—Å—Ç SSL
echo "üß™ –¢–µ—Å—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"
echo "Q" | openssl s_client -connect gtm.baby:443 -servername gtm.baby 2>/dev/null | grep -E "(subject=|issuer=|DNS:)"

echo ""
echo "‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://gtm.baby" 