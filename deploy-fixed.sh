#!/bin/bash

# ============================================================================
# GTM Fixed Deployment Script
# ============================================================================

set -e

echo "üöÄ GTM Fixed Deployment Script"
echo "==============================="
echo "Components: Traefik + API + Bot + Web"
echo "SSL: gtm.baby-ssl-bundle"
echo "API Port: 5000"
echo ""

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
# ============================================================================
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."

SSL_DIR="gtm.baby-ssl-bundle"
if [ -d "$SSL_DIR" ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ $SSL_DIR"
    
    if [ -f "$SSL_DIR/domain.cert.pem" ] && [ -f "$SSL_DIR/private.key.pem" ]; then
        echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á –Ω–∞–π–¥–µ–Ω—ã"
        
        if openssl x509 -in "$SSL_DIR/domain.cert.pem" -checkend 0 -noout 2>/dev/null; then
            echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"
        else
            echo "‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫!"
            exit 1
        fi
    else
        echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
        exit 1
    fi
else
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $SSL_DIR"
    exit 1
fi

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
# ============================================================================
echo ""
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."

if [ -d "/root/gtmall/web" ]; then
    echo "‚úÖ Web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞: /root/gtmall/web"
    ls -la /root/gtmall/web/ | head -5
else
    echo "‚ùå Web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: /root/gtmall/web"
    exit 1
fi

# ============================================================================
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
# ============================================================================
echo ""
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."

docker-compose down 2>/dev/null || true
docker-compose -f docker-compose-fixed.yml down 2>/dev/null || true

# –û—á–∏—Å—Ç–∫–∞ Docker
echo "üßπ –û—á–∏—â–∞–µ–º Docker..."
docker system prune -f

# ============================================================================
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ============================================================================
echo ""
echo "üìù –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Traefik
cp traefik/traefik-fixed.yml traefik/traefik.yml

# ============================================================================
# –ó–∞–ø—É—Å–∫ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
# ============================================================================
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."

docker-compose -f docker-compose-fixed.yml up -d --build

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
# ============================================================================
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."

sleep 10
docker-compose -f docker-compose-fixed.yml ps

echo ""
echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
echo "docker-compose -f docker-compose-fixed.yml logs -f"

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:"
echo "   - –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç: https://gtm.baby"
echo "   - API: https://api.gtm.baby"
echo "   - Traefik Dashboard: https://traefik.gtm.baby"
echo ""
echo "ü§ñ Telegram Bot —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (–±–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)" 