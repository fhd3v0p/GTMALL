#!/bin/bash

# ============================================================================
# GTM Nginx Config Check Script
# ============================================================================

set -e

echo "üîç GTM Nginx Config Check Script"
echo "================================="

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx.conf
# ============================================================================
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx.conf..."

if [ -f "nginx.conf" ]; then
    echo "‚úÖ nginx.conf –Ω–∞–π–¥–µ–Ω"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–µ—Å–ª–∏ nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if command -v nginx &> /dev/null; then
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ nginx..."
        if nginx -t -c "$(pwd)/nginx.conf" 2>/dev/null; then
            echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
            exit 1
        fi
    else
        echo "‚ö†Ô∏è  nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è SSL –±–ª–æ–∫–æ–≤
    if grep -q "ssl_certificate" nginx.conf; then
        echo "‚úÖ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞"
    else
        echo "‚ùå SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ server –±–ª–æ–∫–æ–≤
    if grep -q "server_name gtm.baby" nginx.conf; then
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è gtm.baby –Ω–∞–π–¥–µ–Ω–∞"
    else
        echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è gtm.baby –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –ø—Ä–æ–∫—Å–∏
    if grep -q "proxy_pass" nginx.conf; then
        echo "‚úÖ API –ø—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    else
        echo "‚ùå API –ø—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
    
else
    echo "‚ùå nginx.conf –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
# ============================================================================
echo ""
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."

SSL_DIR="gtm.baby-ssl-bundle"
if [ -d "$SSL_DIR" ]; then
    echo "‚úÖ SSL –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞: $SSL_DIR"
    
    if [ -f "$SSL_DIR/domain.cert.pem" ] && [ -f "$SSL_DIR/private.key.pem" ]; then
        echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –∫–ª—é—á –Ω–∞–π–¥–µ–Ω—ã"
        
        if openssl x509 -in "$SSL_DIR/domain.cert.pem" -checkend 0 -noout 2>/dev/null; then
            echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"
            echo "üìÖ –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è:"
            openssl x509 -in "$SSL_DIR/domain.cert.pem" -noout -enddate
        else
            echo "‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫!"
        fi
    else
        echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    fi
else
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $SSL_DIR"
fi

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ web —Ñ–∞–π–ª–æ–≤
# ============================================================================
echo ""
echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ web —Ñ–∞–π–ª–æ–≤..."

if [ -d "web" ]; then
    echo "‚úÖ Web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞"
    
    if [ -f "web/index.html" ]; then
        echo "‚úÖ index.html –Ω–∞–π–¥–µ–Ω"
    else
        echo "‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    fi
    
    if [ -f "web/admin_new.html" ]; then
        echo "‚úÖ admin_new.html –Ω–∞–π–¥–µ–Ω"
    else
        echo "‚ùå admin_new.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ Flutter
    if [ -f "web/main.dart.js" ]; then
        echo "‚úÖ main.dart.js –Ω–∞–π–¥–µ–Ω"
    else
        echo "‚ùå main.dart.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    if [ -d "web/assets" ]; then
        echo "‚úÖ assets –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞–π–¥–µ–Ω–∞"
    else
        echo "‚ùå assets –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    
else
    echo "‚ùå Web –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
# ============================================================================
echo ""
echo "üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose..."

if [ -f "docker-compose-simple.yml" ]; then
    echo "‚úÖ docker-compose-simple.yml –Ω–∞–π–¥–µ–Ω"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    if grep -q "nginx:" docker-compose-simple.yml; then
        echo "‚úÖ nginx —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    else
        echo "‚ùå nginx —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
    
    if grep -q "api:" docker-compose-simple.yml; then
        echo "‚úÖ api —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    else
        echo "‚ùå api —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    fi
    
else
    echo "‚ùå docker-compose-simple.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üöÄ –î–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./deploy-nginx.sh" 