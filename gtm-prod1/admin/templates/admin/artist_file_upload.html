{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/changelists.css" %}">
  <style>
    .upload-section {
      background: #f8f9fa;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    .upload-form {
      margin: 10px 0;
    }
    .upload-form input[type="file"] {
      margin: 10px 0;
    }
    .upload-form button {
      background: #007cba;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .upload-form button:hover {
      background: #005a87;
    }
    .artist-info {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid #ddd;
    }
    .gallery-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .gallery-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 3px;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module filtered">
    <h2>Управление артистами</h2>
    
    {% for artist in cl.queryset %}
    <div class="upload-section">
      <h3>{{ artist.name }}</h3>
      <div class="artist-info">
        <p><strong>Папка:</strong> {{ artist.folder_name }}</p>
        <p><strong>Категории:</strong> 
          {% for category in artist.categories.all %}
            {{ category.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            Не выбраны
          {% endfor %}
        </p>
        <p><strong>Города:</strong> 
          {% for city in artist.cities.all %}
            {{ city.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            Не выбраны
          {% endfor %}
        </p>
        
        {% if artist.avatar_url %}
        <p><strong>Аватар:</strong> <img src="{{ artist.avatar_url }}" alt="Avatar" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;"></p>
        {% endif %}
      </div>
      
      <!-- Загрузка аватара -->
      <div class="upload-form">
        <h4>Загрузить аватар</h4>
        <form method="post" enctype="multipart/form-data" action="{% url 'admin:upload_avatar' artist.id %}">
          {% csrf_token %}
          <input type="file" name="avatar" accept="image/*" required>
          <button type="submit">Загрузить аватар</button>
        </form>
      </div>
      
      <!-- Загрузка галереи -->
      <div class="upload-form">
        <h4>Загрузить изображения в галерею (максимум 10)</h4>
        <form method="post" enctype="multipart/form-data" action="{% url 'admin:upload_gallery' artist.id %}">
          {% csrf_token %}
          <input type="file" name="gallery" accept="image/*" multiple>
          <button type="submit">Загрузить изображения</button>
        </form>
      </div>
      
      <!-- Предварительный просмотр галереи -->
      <div class="gallery-preview">
        <h4>Галерея работ</h4>
        <div id="gallery-{{ artist.id }}">
          <!-- Здесь будут отображаться изображения из MinIO -->
        </div>
      </div>
    </div>
    {% empty %}
    <p>Нет артистов для отображения.</p>
    {% endfor %}
  </div>
</div>

<script>
// Функция для загрузки галереи из MinIO
function loadGallery(artistId) {
  fetch(`http://localhost:3001/api/admin/artists/${artistId}`)
    .then(response => response.json())
    .then(data => {
      const galleryContainer = document.getElementById(`gallery-${artistId}`);
      if (data.gallery && data.gallery.length > 0) {
        galleryContainer.innerHTML = data.gallery.map(url => 
          `<img src="${url}" alt="Gallery image" title="${url.split('/').pop()}">`
        ).join('');
      } else {
        galleryContainer.innerHTML = '<p>Галерея пуста</p>';
      }
    })
    .catch(error => {
      console.error('Error loading gallery:', error);
      document.getElementById(`gallery-${artistId}`).innerHTML = '<p>Ошибка загрузки галереи</p>';
    });
}

// Загружаем галереи при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  {% for artist in cl.queryset %}
    loadGallery({{ artist.id }});
  {% endfor %}
});
</script>
{% endblock %} 