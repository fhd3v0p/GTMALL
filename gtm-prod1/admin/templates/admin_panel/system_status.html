{% extends 'admin_panel/base.html' %}

{% block title %}–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã - GTM Admin Panel{% endblock %}

{% block content %}
<h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>

<div class="grid">
    <div class="status-card">
        <h3>MinIO Admin</h3>
        <p id="minio-admin-status" class="{% if system_status.minio_admin %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.minio_admin %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>

    <div class="status-card">
        <h3>MinIO API</h3>
        <p id="minio-api-status" class="{% if system_status.minio_api %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.minio_api %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>

    <div class="status-card">
        <h3>GTM API</h3>
        <p id="gtm-api-status" class="{% if system_status.gtm_api %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.gtm_api %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>

    <div class="status-card">
        <h3>PostgreSQL</h3>
        <p id="postgresql-status" class="{% if system_status.postgresql %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.postgresql %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>

    <div class="status-card">
        <h3>Redis</h3>
        <p id="redis-status" class="{% if system_status.redis %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.redis %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>

    <div class="status-card">
        <h3>Web Server</h3>
        <p id="web-server-status" class="{% if system_status.web_server %}status-online{% else %}status-offline{% endif %}">
            {% if system_status.web_server %}‚úÖ –û–Ω–ª–∞–π–Ω{% else %}‚ùå –û—Ñ–ª–∞–π–Ω{% endif %}
        </p>
    </div>
</div>

<div class="status-card">
    <h3>üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
    <p>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</p>
    <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">–°–µ–π—á–∞—Å</span></p>
</div>

<script>
function updateLastUpdate() {
    const now = new Date();
    document.getElementById('last-update').textContent = now.toLocaleTimeString('ru-RU');
}

async function refreshSystemStatus() {
    try {
        const response = await fetch('/api/system-status/');
        const data = await response.json();
        
        if (data.success) {
            const services = data.data;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å MinIO Admin
            const minioAdminStatus = document.getElementById('minio-admin-status');
            if (services.minio_admin) {
                minioAdminStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                minioAdminStatus.className = 'status-online';
            } else {
                minioAdminStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                minioAdminStatus.className = 'status-offline';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å MinIO API
            const minioApiStatus = document.getElementById('minio-api-status');
            if (services.minio_api) {
                minioApiStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                minioApiStatus.className = 'status-online';
            } else {
                minioApiStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                minioApiStatus.className = 'status-offline';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å GTM API
            const gtmApiStatus = document.getElementById('gtm-api-status');
            if (services.gtm_api) {
                gtmApiStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                gtmApiStatus.className = 'status-online';
            } else {
                gtmApiStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                gtmApiStatus.className = 'status-offline';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å PostgreSQL
            const postgresqlStatus = document.getElementById('postgresql-status');
            if (services.postgresql) {
                postgresqlStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                postgresqlStatus.className = 'status-online';
            } else {
                postgresqlStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                postgresqlStatus.className = 'status-offline';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Redis
            const redisStatus = document.getElementById('redis-status');
            if (services.redis) {
                redisStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                redisStatus.className = 'status-online';
            } else {
                redisStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                redisStatus.className = 'status-offline';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Web Server
            const webServerStatus = document.getElementById('web-server-status');
            if (services.web_server) {
                webServerStatus.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω';
                webServerStatus.className = 'status-online';
            } else {
                webServerStatus.textContent = '‚ùå –û—Ñ–ª–∞–π–Ω';
                webServerStatus.className = 'status-offline';
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(refreshSystemStatus, 30000);

// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
setInterval(updateLastUpdate, 30000);

document.addEventListener('DOMContentLoaded', function() {
    updateLastUpdate();
    refreshSystemStatus();
});
</script>
{% endblock %} 