#!/bin/bash

# ============================================================================
# GTM Server Deployment Script
# ============================================================================

set -e

echo "üöÄ GTM Server Deployment Script"
echo "================================"

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
# ============================================================================
if [ $# -eq 0 ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-to-server.sh <SERVER_IP> [SSH_KEY_PATH]"
    echo "–ü—Ä–∏–º–µ—Ä: ./deploy-to-server.sh 31.56.39.165 ~/.ssh/id_rsa_46.203.233.218"
    exit 1
fi

SERVER_IP=$1
SSH_KEY=${2:-"~/.ssh/id_rsa"}

echo "üåê –°–µ—Ä–≤–µ—Ä: $SERVER_IP"
echo "üîë SSH –∫–ª—é—á: $SSH_KEY"

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
# ============================================================================
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."

if ssh -i "$SSH_KEY" -o ConnectTimeout=10 -o BatchMode=yes root@"$SERVER_IP" "echo 'Connection successful'" 2>/dev/null; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "  - IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: $SERVER_IP"
    echo "  - SSH –∫–ª—é—á: $SSH_KEY"
    echo "  - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

# ============================================================================
# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
# ============================================================================
echo ""
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è..."

DEPLOY_ARCHIVE="gtm-nginx-deploy.tar.gz"

# –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
tar -czf "$DEPLOY_ARCHIVE" \
    nginx.conf \
    docker-compose-simple.yml \
    setup-ssl.sh \
    deploy-nginx.sh \
    check-nginx-config.sh \
    NGINX_SETUP.md \
    web/ \
    gtm.baby-ssl-bundle/ \
    api/ \
    database/ \
    bot/

echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $DEPLOY_ARCHIVE"

# ============================================================================
# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ============================================================================
echo ""
echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh -i "$SSH_KEY" root@"$SERVER_IP" "mkdir -p /root/gtm-nginx"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤
scp -i "$SSH_KEY" "$DEPLOY_ARCHIVE" root@"$SERVER_IP":/root/gtm-nginx/

# –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh -i "$SSH_KEY" root@"$SERVER_IP" "cd /root/gtm-nginx && tar -xzf $DEPLOY_ARCHIVE"

echo "‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

# ============================================================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# ============================================================================
echo ""
echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

ssh -i "$SSH_KEY" root@"$SERVER_IP" "cd /root/gtm-nginx && chmod +x setup-ssl.sh && ./setup-ssl.sh"

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# ============================================================================
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

ssh -i "$SSH_KEY" root@"$SERVER_IP" "cd /root/gtm-nginx && chmod +x check-nginx-config.sh && ./check-nginx-config.sh"

# ============================================================================
# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# ============================================================================
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

ssh -i "$SSH_KEY" root@"$SERVER_IP" "cd /root/gtm-nginx && chmod +x deploy-nginx.sh && ./deploy-nginx.sh"

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
# ============================================================================
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."

echo "üîç –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
ssh -i "$SSH_KEY" root@"$SERVER_IP" "cd /root/gtm-nginx && docker-compose -f docker-compose-simple.yml ps"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
ssh -i "$SSH_KEY" root@"$SERVER_IP" "curl -I https://gtm.baby 2>/dev/null | head -1 || echo '‚ùå HTTPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API:"
ssh -i "$SSH_KEY" root@"$SERVER_IP" "curl -I https://api.gtm.baby/health 2>/dev/null | head -1 || echo '‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'"

# ============================================================================
# –û—á–∏—Å—Ç–∫–∞
# ============================================================================
echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."

rm -f "$DEPLOY_ARCHIVE"

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: https://gtm.baby"
echo "üîó API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: https://api.gtm.baby"
echo "üìä –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å: https://gtm.baby/admin/"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: ssh -i $SSH_KEY root@$SERVER_IP 'cd /root/gtm-nginx && docker-compose -f docker-compose-simple.yml ps'"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ssh -i $SSH_KEY root@$SERVER_IP 'cd /root/gtm-nginx && docker-compose -f docker-compose-simple.yml logs nginx'"
echo "  - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ssh -i $SSH_KEY root@$SERVER_IP 'cd /root/gtm-nginx && docker-compose -f docker-compose-simple.yml restart'"
echo "  - –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ssh -i $SSH_KEY root@$SERVER_IP 'cd /root/gtm-nginx && docker-compose -f docker-compose-simple.yml down'" 