#!/bin/bash

# ============================================================================
# GTM Setup Script
# ============================================================================

set -e

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GTM Deployment..."

# ============================================================================
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
# ============================================================================
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."

mkdir -p traefik/ssl/gtm.baby-ssl-bundle
mkdir -p traefik/config
mkdir -p web/build

# ============================================================================
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
# ============================================================================
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±–æ—Ç–∞
cp ../gtm-prod1/bot/bot_main.py bot/
cp ../gtm-prod1/bot/supabase_client.py bot/
cp ../gtm-prod1/bot/webapp_handler.py bot/

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ API
cp ../gtm-prod1/bot/api_server.py api/
cp ../gtm-prod1/bot/supabase_client.py api/

# ============================================================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
# ============================================================================
echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

chmod +x setup.sh
chmod 600 traefik/ssl/gtm.baby-ssl-bundle/* 2>/dev/null || true

# ============================================================================
# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
# ============================================================================
if [ ! -f .env ]; then
    echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
    cp env.example .env
    echo "‚ö†Ô∏è  –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏!"
else
    echo "‚úÖ .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# ============================================================================
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ Docker
# ============================================================================
echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ Docker —Å–µ—Ç–∏..."
docker network create traefik 2>/dev/null || echo "‚úÖ –°–µ—Ç—å traefik —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

# ============================================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
# ============================================================================
if [ -d "traefik/ssl/gtm.baby-ssl-bundle" ] && [ "$(ls -A traefik/ssl/gtm.baby-ssl-bundle)" ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã"
else
    echo "‚ö†Ô∏è  SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ traefik/ssl/gtm.baby-ssl-bundle/"
    echo "   Traefik –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Let's Encrypt –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
fi

# ============================================================================
# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
# ============================================================================
echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"
echo "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ traefik/ssl/gtm.baby-ssl-bundle/ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: docker-compose up -d"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: docker-compose ps"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "- API: https://api.gtm.baby"
echo "- Traefik Dashboard: https://traefik.gtm.baby"
echo "- Web App: https://gtm.baby (–ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)"
echo "" 